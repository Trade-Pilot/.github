# Market Service 설계

## 액션 플로우

### 거래 종목 수집

1. 하루에 한 번 거래소에 거래 종목을 조회합니다.
2. 현재 데이터베이스에 있는 거래 종목 상태와 비교하여 현황을 업데이트합니다.

### 데이터 수집

1. 매 분마다 거래소에 최근 1분봉 가격 정보를 요청합니다.
2. 가격 정보를 저장하고 수집 현황을 최신화합니다.
3. 수집된 데이터를 바탕으로 여러 단위의 데이터를 계산합니다.
4. 계산된 데이터를 저장합니다.

## 도메인 정의

### MarketSymbol (시장 심볼)

- 시장에서 거래 가능한 자산을 식별할 수 있는 식별 정보입니다.
- 거래소를 추가하거나 신규 상장된 경우 생성됩니다.
- 시장 심볼이 등록된 시장은 주식, 코인 등이 있습니다.
- 거래 가능 상태가 변경되거나, 상장 폐지될 때 업데이트됩니다.
- 시장 심볼의 상태는 `상장됨`, `주의됨`, `경고됨`, `거래 중지`, `상장 폐지`가 있습니다.

| **프로퍼티 (한글)** | **프로퍼티 (영문)** | **개념**                                     | **필수** | **불변** |
|:--------------------|:--------------------|:--------------------------------------------|:---------|:---------|
| 식별자              | identifier          | 시장 심볼을 식별하기 위한 식별자             | O        | O        |
| 코드                | code                | 거래소에서 시장 심볼을 식별하기 위한 식별 값 | O        | O        |
| 시장                | market              | 시장 심볼이 등록된 거래소 유형               | O        | O        |
| 상태                | status              | 시장 심볼의 상태                             | O        | O        |
| 생성일              | created_date        | 시장 심볼이 생성된 시각                      | O        | O        |
| 수정일              | modified_date       | 시장 심볼이 수정된 시각                      | O        | O        |

### MarketCandleCollectStatus (시장 캔들 수집 상태)

- 시장 캔들을 수집하는 상태를 관리하는 정보입니다.
- 시장 심볼이 상장되는 시점에 생성되며, 상장 폐지 시 비활성화됩니다.

| **프로퍼티 (한글)** | **프로퍼티 (영문)**  | **개념**                               | **필수** | **불변** |
|:--------------------|:---------------------|:--------------------------------------|:---------|:---------|
| 식별자              | identifier           | 시장 캔들 수집 상태 식별자             | O        | O        |
| 시장심볼식별자      | symbol_identifier    | 상태를 관리하는 시장 심볼의 식별자     | O        | O        |
| 생성일시            | created_date         | 수집 상태가 생성된 시각                | O        | O        |
| 최근 수집된 일시    | last_collected_date  | 최근에 시장 캔들이 수집된 일시         | O        | O        |

### MarketCandle (시장 캔들)

- 특정 기간 동안의 시장 가격 데이터를 나타내는 정보입니다.
- 1분, 5분, 15분, 30분, 1시간, 4시간, 1일 등의 다양한 시간 간격으로 생성됩니다.
- 시가, 고가, 저가, 종가와 거래량 정보를 포함합니다.
- 기술적 분석과 차트 시각화에 사용되는 핵심 데이터입니다.
- 실시간으로 업데이트되며, 과거 데이터는 불변으로 유지됩니다.

| **프로퍼티 (한글)** | **프로퍼티 (영문)** | **개념**                                     | **필수** | **불변** |
|:--------------------|:--------------------|:---------------------------------------------|:---------|:---------|
| 식별자              | identifier          | 캔들 데이터를 식별하기 위한 고유 식별자      | O        | O        |
| 시장심볼식별자      | symbol_identifier   | 캔들이 속한 시장 심볼의 식별자               | O        | O        |
| 시간간격            | interval            | 캔들의 시간 간격 (1m, 5m, 15m, 1h, 1d 등)   | O        | O        |
| 시가                | open_price          | 해당 기간의 시작 가격                        | O        | O        |
| 고가                | high_price          | 해당 기간의 최고 가격                        | O        | O        |
| 저가                | low_price           | 해당 기간의 최저 가격                        | O        | O        |
| 종가                | close_price         | 해당 기간의 마지막 가격                      | O        | O        |
| 거래량              | volume              | 해당 기간의 총 거래량                        | O        | O        |
| 거래금액            | quote_volume        | 해당 기간의 총 거래 금액                     | O        | O        |
| 시작시각            | start_time          | 캔들 기간의 시작 시각                        | O        | O        |
| 종료시각            | end_time            | 캔들 기간의 종료 시각                        | O        | O        |

## 시퀀스 다이어그램

### 시장 심볼 수집

```mermaid
sequenceDiagram
    participant m as Market Service
    participant k as Kafka
    participant e as Exchange Service
    participant ex as Exchange

    autoNumber

    m -->> k : 시장 심볼 요청 메시지 발행
    k -->> e : 시장 심볼 요청 메시지 소비
    e ->> ex : 시장 심볼 조회 요청
    ex ->> e : 시장 심볼 조회 응답
    e -->> k : 시장 심볼 요청 메시지 발행
    k -->> m : 시장 심볼 요청 메시지 소비

    alt 시장 심볼이 기존에 있는 경우
        m ->> m : 시장 심볼 업데이트
    else 시장 심볼이 처음 조회된 경우
        m ->> m : 시장 심볼 등록 (상장)
    else 조회가 되지 않은 시장 심볼이 있는 경우
        m ->> m : 시장 심볼 상장 폐지
    end

    m ->> m : 시장 캔들 수집 현황 업데이트

    m -->> k : 도메인 이벤트 발행
```

### 시장 캔들 수집

```mermaid
sequenceDiagram
    participant m as Market Service
    participant k as Kafka
    participant e as Exchange Service
    participant ex as Exchange

    autoNumber

    m ->> m : 수집이 가능한 수집 현황 조회

    m -->> k : 시장 캔들 요청 메시지 발행
    k -->> e : 시장 캔들 요청 메시지 소비
    e ->> ex : 시장 캔들 조회 요청
    ex ->> e : 시장 캔들 조회 응답
    e -->> k : 시장 캔들 응답 메시지 발행
    k -->> m : 시장 캔들 응답 메시지 소비

    m ->> m : 시장 캔들 저장
    m ->> m : 수집 현황 업데이트
    m ->> m : 다양한 시간 간격 캔들 데이터 계산 및 저장
```
